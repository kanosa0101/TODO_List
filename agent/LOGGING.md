# Agent服务日志增强说明

## 概述

Agent服务现在包含详细的日志记录功能，帮助您监控和调试LLM API调用。

## 日志内容

### 1. HTTP请求/响应日志

每个HTTP请求都会记录：

```
============================================================
📥 收到请求 [20251122153000123]
   方法: POST
   路径: /api/chat/stream
   来源: 127.0.0.1
   User-Agent: Mozilla/5.0...
   请求头: {...}
   请求体: {...}  # 敏感字段已隐藏

📤 响应 [20251122153000123]
   状态码: 200
   耗时: 1234.56ms
   响应头: {...}
   响应体: {...}
============================================================
```

**特点：**
- 自动隐藏敏感信息（API密钥、密码等）
- 记录请求耗时
- 完整的请求/响应内容

### 2. 聊天请求详细日志

**非流式聊天 (`/api/chat`)：**
```
[20251122153000123] ========== 收到非流式聊天请求 ==========
[20251122153000123] 请求来源: 127.0.0.1
[20251122153000123] 请求参数:
[20251122153000123]   - 消息数量: 2
[20251122153000123]   - 温度: 0.7
[20251122153000123]   - 消息内容:
[20251122153000123]     [1] system: You are a helpful assistant
[20251122153000123]     [2] user: 你好，请介绍一下你自己
[20251122153000123] 正在调用 LLM (模型: gpt-4)...
[20251122153000123] LLM调用成功，耗时: 2.34 秒
[20251122153000123] 响应长度: 156 字符
[20251122153000123] 响应预览: 你好！我是一个AI助手...
[20251122153000123] ========== 请求完成 ==========
```

**流式聊天 (`/api/chat/stream`)：**
```
[20251122153000456] ========== 收到新的聊天请求 ==========
[20251122153000456] 请求来源: 127.0.0.1
[20251122153000456] 请求参数:
[20251122153000456]   - 消息数量: 3
[20251122153000456]   - 温度: 0
[20251122153000456]   - 用户Token: 已提供
[20251122153000456]   - 完整消息历史:
[20251122153000456]     [1] system: You are a helpful assistant...
[20251122153000456]     [2] user: 查看我的待办事项
[20251122153000456]     [3] assistant: 好的，让我查看...
[20251122153000456] 已加载 12 个 MCP 工具
[20251122153000456] ---------- 迭代 1/10 ----------
[20251122153000456] 当前消息历史长度: 3
[20251122153000456] 正在调用 LLM (模型: gpt-4)...
[20251122153000456] LLM 流式调用完成，耗时: 1.23秒
[20251122153000456] 检测到 1 个工具调用
[20251122153000456] 工具调用 1/1: list_todos
[20251122153000456]   参数: {
  "completed": false
}
[20251122153000456] 工具执行完成，耗时: 0.15秒
[20251122153000456]   成功: True
[20251122153000456]   结果: {"success": true, "data": [...]}
[20251122153000456] 最终响应已流式发送完毕
[20251122153000456] ========== 请求完成 ==========
```

### 3. LLM API调用日志

在 `llm_client.py` 中：

```
🧠 调用 gpt-4 模型...
   参数: temperature=0.7
   消息数: 2
   发起 API 请求...
   ✅ API 连接成功，开始接收流式响应...
   ✅ 响应接收完成
   接收块数: 24
   响应长度: 156 字符
   耗时: 2.34 秒
   速度: 66.7 字符/秒
```

### 4. 工具调用日志

MCP工具调用的详细信息：

```
[20251122153000456] 工具调用 1/2: create_todo
[20251122153000456]   参数: {
  "title": "完成报告",
  "description": "写季度总结报告",
  "priority": "high"
}
[20251122153000456] 工具执行完成，耗时: 0.23秒
[20251122153000456]   成功: True
[20251122153000456]   结果: {"success": true, "data": {"id": 123, ...}}
```

### 5. 错误日志

完整的错误追踪：

```
[20251122153000789] ❌ 处理请求时发生异常: Connection timeout
[20251122153000789] 异常堆栈:
Traceback (most recent call last):
  File "app.py", line 95, in chat
    response_text = llm_client.think(messages, temperature)
  File "llm_client.py", line 60, in think
    response = self.client.chat.completions.create(...)
  requests.exceptions.Timeout: Connection timeout

[LLM API错误示例]
   ❌ 调用LLM API失败: Invalid API key
   失败时间: 0.15 秒后
   模型: gpt-4
   错误类型: AuthenticationError
   详细堆栈:
   ...
```

## 日志级别

- `INFO`: 正常操作日志（请求、响应、成功的操作）
- `WARNING`: 警告信息（配置问题、非关键错误）
- `ERROR`: 错误日志（API调用失败、异常）

## 敏感信息保护

以下字段会自动被隐藏或脱敏：
- API密钥 (`api_key`, `LLM_API_KEY`)
- 密码 (`password`)
- Token (`token`, `Authorization`)
- Cookie
- Secret

显示为 `***` 或部分隐藏（如API密钥只显示前10个字符）

## 查看日志

日志会直接输出到终端（控制台），您可以：

1. **直接查看终端输出**
   ```bash
   venv\Scripts\python.exe start.py
   ```

2. **重定向到文件**（可选）
   ```bash
   venv\Scripts\python.exe start.py > logs\agent.log 2>&1
   ```

3. **使用日志查看工具**（可选）
   - Windows: 使用 PowerShell 的 `Get-Content -Wait` 实时查看
   - 或使用专业的日志查看工具如 Notepad++, VSCode等

## 日志示例场景

### 成功的对话请求
```
2025-11-22 15:30:00 [INFO] ========== 收到新的聊天请求 ==========
2025-11-22 15:30:00 [INFO] 请求来源: 127.0.0.1
2025-11-22 15:30:00 [INFO] 请求参数:
2025-11-22 15:30:00 [INFO]   - 消息数量: 1
2025-11-22 15:30:00 [INFO]   - 温度: 0
2025-11-22 15:30:00 [INFO]   - 完整消息历史:
2025-11-22 15:30:00 [INFO]     [1] user: 你好
2025-11-22 15:30:01 [INFO] 🧠 调用 gpt-4 模型...
2025-11-22 15:30:01 [INFO]    API 连接成功，开始接收流式响应...
2025-11-22 15:30:03 [INFO]    ✅ 响应接收完成
2025-11-22 15:30:03 [INFO]    响应长度: 45 字符
2025-11-22 15:30:03 [INFO]    耗时: 2.15 秒
2025-11-22 15:30:03 [INFO] ========== 请求完成 ==========
```

### 工具调用场景
```
2025-11-22 15:35:00 [INFO] 检测到 1 个工具调用
2025-11-22 15:35:00 [INFO] 工具调用 1/1: list_todos
2025-11-22 15:35:00 [INFO]   参数: {"completed": false}
2025-11-22 15:35:00 [INFO] 工具执行完成，耗时: 0.12秒
2025-11-22 15:35:00 [INFO]   成功: True
2025-11-22 15:35:00 [INFO]   结果: {"success": true, "data": [5 items]}
```

### 错误场景
```
2025-11-22 15:40:00 [ERROR] ❌ 调用LLM API失败: Connection timeout
2025-11-22 15:40:00 [ERROR]    失败时间: 30.00 秒后
2025-11-22 15:40:00 [ERROR]    模型: gpt-4
2025-11-22 15:40:00 [ERROR]    错误类型: Timeout
2025-11-22 15:40:00 [ERROR]    详细堆栈:
Traceback (most recent call last):
  ...
```

## 总结

现在的日志系统提供了：
✅ 完整的请求/响应追踪
✅ 详细的LLM API调用信息
✅ 工具调用的完整记录
✅ 性能指标（耗时、速度等）
✅ 全面的错误追踪
✅ 敏感信息自动保护

这些日志可以帮助您：
- 调试问题
- 监控性能
- 了解用户行为
- 追踪错误原因
